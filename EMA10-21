//@version=6
strategy("EMA 10/21 Trend + Supply/Demand Zones (Backtest)", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// --- 1. EMA TREND LOGIC (UNCHANGED) ---
shortLength = input.int(10, title="Short EMA Length")
longLength  = input.int(21, title="Long EMA Length")

shortEMA = ta.ema(close, shortLength)
longEMA  = ta.ema(close, longLength)

// Trend identification
var trend = 0
if shortEMA > longEMA
    trend := 1
else if shortEMA < longEMA
    trend := -1
else
    trend := 0

// Plot EMAs & Background 
plot(shortEMA, color=color.new(color.green, 0), title="10 EMA")
plot(longEMA, color=color.new(color.red, 0), title="21 EMA")
bgcolor(trend == 1 ? color.new(color.green, 90) : trend == -1 ? color.new(color.red, 90) : na)

// Signal logic 
longSignal  = trend == 1  and trend[1] != 1
shortSignal = trend == -1 and trend[1] != -1

//  STRATEGY EXECUTION  
if longSignal
    strategy.close("Short")
    strategy.entry("Long", strategy.long)

if shortSignal
    strategy.close("Long")
    strategy.entry("Short", strategy.short)

/// SUPPLY / DEMAND ZONES 
pivotLookback = input.int(15, title="Pivot Lookback Bars")
zoneWidth     = input.int(2, title="Zone Thickness (in Ticks)")

isPivotHigh = ta.pivothigh(high, pivotLookback, pivotLookback)
isPivotLow  = ta.pivotlow(low, pivotLookback, pivotLookback)

// Supply Zone
if not na (isPivotHigh)
    zoneHigh = high[pivotLookback]
    zoneLow  = zoneHigh - syminfo.mintick * zoneWidth
    box.new(left=bar_index[pivotLookback], right=bar_index + 1, top=zoneHigh, bottom=zoneLow, border_color=color.rgb(255, 0, 0, 50), bgcolor=color.rgb(255, 0, 0, 80))

// Demand Zone
if not na (isPivotLow)
    zoneLow  = low[pivotLookback]
    zoneHigh = zoneLow + syminfo.mintick * zoneWidth
    box.new(left=bar_index[pivotLookback], right=bar_index + 1, top=zoneHigh, bottom=zoneLow, border_color=color.rgb(0, 128, 0, 50), bgcolor=color.rgb(0, 128, 0, 80))
